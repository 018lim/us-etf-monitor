# -*- coding: utf-8 -*-
"""monitor_us.py.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1qN3x9Ipu3omZJ85SueQ2ihPkxNMotD-e
"""

# -*- coding: utf-8 -*-
"""monitor_us.py"""

import os
import time
import sys
import requests
import yfinance as yf
from datetime import datetime, timedelta
import pytz

# âœ… í…”ë ˆê·¸ë¨ ì•Œë¦¼ í•¨ìˆ˜ (ë³´ì•ˆ ì ìš©)
def send_telegram_alert(message):
    BOT_TOKEN = os.getenv("BOT_TOKEN")
    CHAT_ID = os.getenv("CHAT_ID")
    url = f"https://api.telegram.org/bot{BOT_TOKEN}/sendMessage"
    payload = {"chat_id": CHAT_ID, "text": message}
    response = requests.post(url, data=payload)
    print(f"[í…”ë ˆê·¸ë¨ ì‘ë‹µ] {response.status_code} / {response.text}")

# âœ… ë‰´ìš• ì‹œê°„ ë°˜í™˜ (ì„œë¨¸íƒ€ì„ ìë™ ë°˜ì˜)
def get_ny_time():
    ny = pytz.timezone("America/New_York")
    return datetime.now(ny)

# âœ… ê°ì‹œ ëŒ€ìƒ (ë¯¸êµ­ ì¢…ëª©)
TICKERS = {
    "SOXL": "SOXL",
    "í€„ì»´":"QCOM",
    "DGRO": "DGRO",
    "êµ¬ê¸€": "GOOG",
    "ë§ˆì´í¬ë¡ ": "MU"

}

INTERVAL_SECONDS = 60  # 1ë¶„ ê°„ê²© ê°ì‹œ

# âœ… ì¼ì¼ ë“±ë½ë¥  í‘œì¤€í¸ì°¨ ê³„ì‚° (ìµœëŒ€ 5ë…„ì¹˜)
def get_return_std(ticker):
    df = yf.download(ticker, period="1250d", interval="1d")
    df['Return'] = df['Close'].pct_change()
    df = df.dropna()
    return float(df['Return'].std())

# âœ… ì „ì¼ ì¢…ê°€ / í˜„ì¬ê°€
def get_prev_close_and_current_price(ticker):
    daily = yf.download(ticker, period="2d", interval="1d")
    if len(daily) < 2:
        return None, None
    prev_close = daily['Close'].iloc[-2].item()

    intraday = yf.download(ticker, period="1d", interval="1m")
    if intraday.empty:
        return None, None
    current_price = intraday['Close'].iloc[-1].item()

    return prev_close, current_price

# âœ… ê°ì‹œ ë£¨í”„
def run_monitor():
    ny_now = get_ny_time()
    if ny_now.weekday() >= 5:  # ì£¼ë§ì´ë©´ ì¢…ë£Œ
        send_telegram_alert("ğŸ›‘ ì£¼ë§ì…ë‹ˆë‹¤. ê°ì‹œ ì¢…ë£Œí•©ë‹ˆë‹¤.")
        sys.exit()

    send_telegram_alert("ğŸš¨ ë¯¸êµ­ ì£¼ì‹ ê°ì‹œë¥¼ ì‹œì‘í•©ë‹ˆë‹¤!")

    thresholds = {}
    notified = {code: False for code in TICKERS}

    # âœ… ì‹œì‘ ì‹œ ì¢…ëª©ë³„ ë§¤ìˆ˜ ê¸°ì¤€ ì•Œë¦¼ ì „ì†¡
    startup_messages = []

    for code, ticker in TICKERS.items():
        std = get_return_std(ticker)
        threshold = 2 * std
        thresholds[code] = threshold

        daily = yf.download(ticker, period="2d", interval="1d")
        if len(daily) < 2:
            startup_messages.append(f"[{code}] âŒ ì „ì¼ ì¢…ê°€ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨")
            continue

        prev_close = daily['Close'].iloc[-2].item()
        buy_price = int(prev_close * (1 - threshold))

        msg = (
            f"ğŸ“Š [{code}] ë§¤ìˆ˜ ê¸°ì¤€ ì•ˆë‚´\n"
            f"- ì „ì¼ ì¢…ê°€: {prev_close:,.2f}\n"
            f"- 2Ïƒ ë“±ë½í­: {threshold:.2%}\n"
            f"- ë§¤ìˆ˜ ê¸°ì¤€ê°€: {buy_price:,}"
        )
        startup_messages.append(msg)
        print(msg)

    for msg in startup_messages:
        send_telegram_alert(msg)

    print("âœ… ì´ˆê¸° ì•Œë¦¼ ì „ì†¡ ì™„ë£Œ")

    # âœ… ê°ì‹œ ë£¨í”„ ì‹œì‘
    while True:
        ny_now = get_ny_time()
        hour = ny_now.hour
        minute = ny_now.minute

        # âœ… ë¯¸êµ­ ì‹œì¥ ê°ì‹œ ì‹œê°„ (09:30 ~ 16:00 NY ê¸°ì¤€)
        if (hour < 9 or (hour == 9 and minute < 30)) or hour >= 16:
            send_telegram_alert("â¹ï¸ ë¯¸êµ­ ì‹œì¥ ê°œì¥ ì‹œê°„ ì™¸ì…ë‹ˆë‹¤. ê°ì‹œ ì¢…ë£Œí•©ë‹ˆë‹¤.")
            sys.exit()

        for code, ticker in TICKERS.items():
            if notified[code]:
                print(f"[{code}] âœ… ê°ì‹œ ì™„ë£Œ â†’ ì œì™¸")
                continue

            try:
                prev_close, current_price = get_prev_close_and_current_price(ticker)
                if prev_close is None or current_price is None:
                    print(f"[{code}] ê°€ê²© ìˆ˜ì‹  ì‹¤íŒ¨")
                    continue

                change_pct = abs((current_price - prev_close) / prev_close)
                diff = (current_price - prev_close) / prev_close
                threshold = thresholds[code]

                print(f"[{code}] í˜„ì¬ ë“±ë½ë¥  ë³€í™”: {change_pct:.2%} / ê¸°ì¤€: {threshold:.2%}")

                if change_pct > threshold:
                    if prev_close > current_price:
                        msg = (
                            f"ğŸš¨ {code} ë§¤ìˆ˜ íƒ€ì´ë°\n"
                            f"ì „ì¼ì¢…ê°€: {prev_close:,.2f}\n"
                            f"ë§¤ìˆ˜ ê¸°ì¤€ê°€: {int(prev_close * (1 - threshold)):,}\n"
                            f"ë³€í™”ìœ¨: {diff:.2%} < -{threshold:.2%}\n"
                            f"í˜„ì¬ê°€: {current_price:,.2f} (ì „ì¼ ëŒ€ë¹„: {int(current_price - prev_close)})"
                        )
                    else:
                        msg = (
                            f"ğŸš¨ {code} ë§¤ë„ íƒ€ì´ë°\n"
                            f"ì „ì¼ì¢…ê°€: {prev_close:,.2f}\n"
                            f"ë§¤ë„ ê¸°ì¤€ê°€: {int(prev_close * (1 + threshold)):,}\n"
                            f"ë³€í™”ìœ¨: {diff:.2%} > +{threshold:.2%}\n"
                            f"í˜„ì¬ê°€: {current_price:,.2f} (ì „ì¼ ëŒ€ë¹„: +{int(current_price - prev_close)})"
                        )
                    send_telegram_alert(msg)
                    notified[code] = True

                    if all(notified.values()):
                        send_telegram_alert("âœ… ëª¨ë“  ê°ì‹œ ì¢…ëª© ì•Œë¦¼ ì™„ë£Œ. í”„ë¡œê·¸ë¨ ì¢…ë£Œ.")
                        sys.exit()
                else:
                    print(f"[{code}] ë³€í™”ìœ¨ ì •ìƒ ë²”ìœ„")

            except Exception as e:
                print(f"[{code}] ì˜¤ë¥˜: {e}")
                send_telegram_alert(f"âŒ {code} ì˜¤ë¥˜: {e}")

        time.sleep(INTERVAL_SECONDS)

# âœ… ì‹¤í–‰
try:
    run_monitor()
except SystemExit:
    pass